<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assinaturas Pendentes</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px }
canvas { border: 1px solid #000; touch-action: none }
button { margin: 3px }
.pendente, .assinado {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
.assinado img {
  max-width: 250px;
  border: 1px solid #000;
}
</style>
</head>

<body>

<h2>Gestão de Assinaturas</h2>

<!-- CADASTRO DE ASSINANTE -->
<input id="novoNome" placeholder="Nome do assinante">
<button onclick="adicionarAssinante()">Adicionar</button>

<h3>Assinantes</h3>
<div id="lista"></div>

<hr>

<!-- ÁREA DE ASSINATURA -->
<div id="areaAssinatura" style="display:none">
  <h3>Assinar: <span id="assinanteAtual"></span></h3>

  <canvas id="canvas" width="320" height="160"></canvas><br>

  <button onclick="assinar()">Confirmar Assinatura</button>
  <div id="qrcode"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ================= DADOS =================
const pendencia = {
  assinantes: []
};

let indiceAtual = null;

// ================= CANVAS =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let desenhando = false;

canvas.addEventListener("pointerdown", e => {
  desenhando = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener("pointermove", e => {
  if (!desenhando) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup", () => desenhando = false);

// ================= HASH =================
async function gerarHash(texto) {
  const data = new TextEncoder().encode(texto);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ================= ADICIONAR ASSINANTE =================
function adicionarAssinante() {
  const nome = document.getElementById("novoNome").value;
  if (!nome) return alert("Informe o nome");

  pendencia.assinantes.push({
    nome,
    status: "Pendente",
    assinatura: null
  });

  document.getElementById("novoNome").value = "";
  renderizar();
}

// ================= RENDER =================
function renderizar() {
  const div = document.getElementById("lista");
  div.innerHTML = "";

  pendencia.assinantes.forEach((a, i) => {
    const bloco = document.createElement("div");
    bloco.className = a.status === "Pendente" ? "pendente" : "assinado";

    bloco.innerHTML = `
      <b>${a.nome}</b><br>
      Status: ${a.status}<br>
      ${a.status === "Pendente"
        ? `<button onclick="abrirAssinatura(${i})">Assinar</button>
           <button onclick="gerarQR(${i})">QR Code</button>`
        : `
          Data/Hora: ${a.assinatura.dataHora}<br>
          Hash: ${a.assinatura.hash}<br>
          <img src="${a.assinatura.imagem}">
        `}
    `;
    div.appendChild(bloco);
  });
}

// ================= ABRIR ASSINATURA =================
function abrirAssinatura(i) {
  indiceAtual = i;
  document.getElementById("assinanteAtual").innerText =
    pendencia.assinantes[i].nome;

  document.getElementById("areaAssinatura").style.display = "block";
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// ================= GERAR QR =================
function gerarQR(i) {
  const payload = btoa(JSON.stringify({ pendencia, indice: i }));
  const url = `${location.origin}${location.pathname}?p=${payload}`;

  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
}

// ================= LER QR =================
const params = new URLSearchParams(location.search);
if (params.get("p")) {
  const data = JSON.parse(atob(params.get("p")));
  Object.assign(pendencia, data.pendencia);
  abrirAssinatura(data.indice);
  renderizar();
}

// ================= ASSINAR =================
async function assinar() {
  const a = pendencia.assinantes[indiceAtual];
  const imagem = canvas.toDataURL();
  const dataHora = new Date().toLocaleString("pt-BR");

  const hash = await gerarHash(
    a.nome + imagem + dataHora
  );

  a.status = "Assinado";
  a.assinatura = { imagem, dataHora, hash };

  document.getElementById("areaAssinatura").style.display = "none";
  document.getElementById("qrcode").innerHTML = "";
  renderizar();
}
</script>

</body>
</html>
