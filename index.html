<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assinatura Digital - Multiassinantes</title>

<style>
body { font-family: Arial, sans-serif; margin: 20px }
canvas {
  border: 1px solid #000;
  cursor: crosshair;
  touch-action: none;
}
button { margin: 5px }
#qrcode { margin-top: 15px }
.assinatura {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
}
.assinatura img {
  max-width: 250px;
  border: 1px solid #000;
}
</style>
</head>

<body>

<h2>Documento</h2>

<label>Nome do assinante:</label><br>
<input id="nome" placeholder="Nome completo"><br><br>

<canvas id="canvas" width="320" height="160"></canvas><br>

<button onclick="assinar()">Assinar nesta tela</button>
<button onclick="gerarQRCode()">Assinar por outro dispositivo</button>

<div id="qrcode"></div>

<p><b>Status:</b> <span id="status">Pendente</span></p>

<h3>Assinaturas realizadas</h3>
<div id="listaAssinaturas"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ================= CONTEXTO =================
const pendencia = {
  status: "Pendente",
  assinaturas: []
};

// ================= CANVAS (POINTER EVENTS) =================
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let desenhando = false;

canvas.addEventListener("pointerdown", e => {
  desenhando = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
  canvas.setPointerCapture(e.pointerId);
});

canvas.addEventListener("pointermove", e => {
  if (!desenhando) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});

canvas.addEventListener("pointerup", () => desenhando = false);
canvas.addEventListener("pointerleave", () => desenhando = false);

// ================= HASH SHA-256 =================
async function gerarHash(texto) {
  const data = new TextEncoder().encode(texto);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ================= GERAR QR CODE =================
function gerarQRCode() {
  const payload = btoa(JSON.stringify(pendencia));
  const url = `${location.origin}${location.pathname}?p=${payload}`;

  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
}

// ================= LER QR CODE =================
const params = new URLSearchParams(location.search);
const encoded = params.get("p");

if (encoded) {
  try {
    Object.assign(pendencia, JSON.parse(atob(encoded)));
    atualizarLista();
  } catch {
    alert("Pendência inválida");
  }
}

// ================= ASSINAR =================
async function assinar() {
  const nome = document.getElementById("nome").value;
  if (!nome) return alert("Informe o nome do assinante");

  const imagem = canvas.toDataURL();
  const dataHora = new Date().toLocaleString("pt-BR");

  const hash = await gerarHash(
    nome + imagem + dataHora
  );

  pendencia.assinaturas.push({
    nome,
    dataHora,
    hash,
    imagem
  });

  pendencia.status = "Assinatura recebida";

  document.getElementById("status").innerText = pendencia.status;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  atualizarLista();
}

// ================= ATUALIZAR LISTA =================
function atualizarLista() {
  const div = document.getElementById("listaAssinaturas");
  div.innerHTML = "";

  pendencia.assinaturas.forEach((a, i) => {
    const bloco = document.createElement("div");
    bloco.className = "assinatura";

    bloco.innerHTML = `
      <b>Assinante ${i + 1}</b><br>
      <b>Nome:</b> ${a.nome}<br>
      <b>Data/Hora:</b> ${a.dataHora}<br>
      <b>Hash:</b> ${a.hash}<br><br>
      <img src="${a.imagem}">
    `;

    div.appendChild(bloco);
  });
}
</script>

</body>
</html>
