<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assinatura Digital</title>

<style>
body { font-family: Arial; margin: 20px }
canvas { border: 1px solid #000; cursor: crosshair; touch-action: none }
button { margin: 5px }
#qrcode { margin-top: 15px }
</style>
</head>

<body>

<h2>Documento</h2>

<div id="telaPrincipal">
  <label>Nome do assinante:</label><br>
  <input id="nome" placeholder="Nome completo"><br><br>

  <canvas id="canvas" width="300" height="150"></canvas><br>

  <button onclick="assinar()">Assinar nesta tela</button>
  <button onclick="gerarQRCode()">Assinar por outro dispositivo</button>

  <div id="qrcode"></div>

  <p><b>Status:</b> <span id="status">Pendente</span></p>
  <p id="hash"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ================= CONTEXTO =================
const pendencia = {
  nome: "",
  status: "Pendente",
  assinaturas: []
};

let canvas, ctx, desenhando = false;

// ================= HASH =================
async function gerarHash(texto) {
  const data = new TextEncoder().encode(texto);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ================= CANVAS INIT =================
function iniciarCanvas() {
  canvas = document.getElementById("canvas");
  ctx = canvas.getContext("2d");

  ctx.lineWidth = 2;
  ctx.lineCap = "round";

  canvas.onmousedown = () => {
    desenhando = true;
    ctx.beginPath();
  };

  canvas.onmouseup = () => desenhando = false;

  canvas.onmousemove = e => {
    if (!desenhando) return;
    ctx.lineTo(e.offsetX, e.offsetY);
    ctx.stroke();
  };

  // MOBILE
  canvas.ontouchstart = e => {
    desenhando = true;
    const t = e.touches[0];
    const r = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(t.clientX - r.left, t.clientY - r.top);
  };

  canvas.ontouchmove = e => {
    if (!desenhando) return;
    const t = e.touches[0];
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(t.clientX - r.left, t.clientY - r.top);
    ctx.stroke();
    e.preventDefault();
  };

  canvas.ontouchend = () => desenhando = false;
}

// ================= QR CODE =================
function gerarQRCode() {
  if (!pendencia.nome) {
    pendencia.nome = document.getElementById("nome").value;
    if (!pendencia.nome) return alert("Informe o nome");
  }

  const payload = btoa(JSON.stringify(pendencia));
  const url = `${location.origin}${location.pathname}?p=${payload}`;

  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
}

// ================= LEITURA QR =================
const params = new URLSearchParams(location.search);
const encoded = params.get("p");

if (encoded) {
  try {
    Object.assign(pendencia, JSON.parse(atob(encoded)));
    document.getElementById("nome").value = pendencia.nome;
    document.getElementById("status").innerText = pendencia.status;
  } catch {
    alert("Pendência inválida");
  }
}

// ================= ASSINAR =================
async function assinar() {
  if (!pendencia.nome) {
    pendencia.nome = document.getElementById("nome").value;
    if (!pendencia.nome) return alert("Informe o nome");
  }

  const imagem = canvas.toDataURL();
  const dataHora = new Date().toISOString();

  const hash = await gerarHash(
    pendencia.nome + imagem + dataHora
  );

  pendencia.assinaturas.push({ imagem, dataHora, hash });
  pendencia.status = "Assinatura recebida";

  document.getElementById("status").innerText = pendencia.status;
  document.getElementById("hash").innerText = "Hash SHA-256: " + hash;
}

// ================= START =================
iniciarCanvas();
</script>

</body>
</html>
