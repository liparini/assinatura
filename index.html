<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Assinatura Externa com QR Code</title>

<style>
body { font-family: Arial; margin: 20px }
canvas { border: 1px solid #000 }
button { margin-top: 10px }
</style>
</head>

<body>

<h2>Assinatura Externa</h2>

<div id="telaCriacao">
  <label>Nome do assinante:</label><br>
  <input id="nome" placeholder="Nome completo"><br><br>
  <button onclick="criarPendencia()">Enviar para assinatura externa</button>
  <div id="qrcode"></div>
</div>

<hr>

<div id="telaAssinatura" style="display:none">
  <h3>Assinatura pendente</h3>
  <p><strong>Nome:</strong> <span id="nomeAssinante"></span></p>
  <p><strong>Status:</strong> <span id="status"></span></p>

  <canvas id="canvas" width="300" height="150"></canvas><br>
  <button onclick="assinar()">Assinar</button>

  <p id="hash"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script>
// ================== UTIL ==================
function gerarId() {
  return crypto.randomUUID();
}

async function gerarHash(texto) {
  const encoder = new TextEncoder();
  const data = encoder.encode(texto);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

// ================== CRIAÇÃO ==================
function criarPendencia() {
  const nome = document.getElementById("nome").value;
  if (!nome) return alert("Informe o nome");

  const id = gerarId();

  const pendencia = {
    id,
    nome,
    status: "Pendente",
    assinaturas: []
  };

  localStorage.setItem(id, JSON.stringify(pendencia));

  const url = `${location.origin}${location.pathname}?id=${id}`;

  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
}

// ================== LEITURA QR ==================
const params = new URLSearchParams(location.search);
const id = params.get("id");

if (id) {
  document.getElementById("telaCriacao").style.display = "none";
  document.getElementById("telaAssinatura").style.display = "block";

  const pendencia = JSON.parse(localStorage.getItem(id));
  if (!pendencia) alert("Pendência não encontrada");

  document.getElementById("nomeAssinante").innerText = pendencia.nome;
  document.getElementById("status").innerText = pendencia.status;
}

// ================== CANVAS ==================
const canvas = document.getElementById("canvas");
const ctx = canvas?.getContext("2d");
let desenhando = false;

canvas?.addEventListener("mousedown", () => {
  desenhando = true;
  ctx.beginPath();
});
canvas?.addEventListener("mouseup", () => desenhando = false);
canvas?.addEventListener("mousemove", e => {
  if (!desenhando) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});

// ================== ASSINAR ==================
async function assinar() {
  const pendencia = JSON.parse(localStorage.getItem(id));
  if (!pendencia) return;

  const assinaturaBase64 = canvas.toDataURL();
  const dataHora = new Date().toISOString();

  const hash = await gerarHash(
    pendencia.nome + assinaturaBase64 + dataHora
  );

  pendencia.assinaturas.push({
    assinatura: assinaturaBase64,
    dataHora,
    hash
  });

  pendencia.status = "Assinatura recebida";

  localStorage.setItem(id, JSON.stringify(pendencia));

  document.getElementById("status").innerText = pendencia.status;
  document.getElementById("hash").innerText = "Hash SHA-256: " + hash;
}
</script>

</body>
</html>
