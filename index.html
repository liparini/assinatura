<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assinatura Digital</title>
<style>
body { font-family: Arial; padding: 20px; }
input, button { padding: 8px; margin: 5px; }
canvas { border: 1px solid #ccc; }
.assinado { color: green; font-weight: bold; }
.pendente { color: orange; font-weight: bold; }
.card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
</style>
</head>

<body>

<h2>Criar Pendência</h2>
<input id="nomeAssinante" placeholder="Nome do assinante">
<button onclick="adicionarAssinante()">Adicionar assinante</button>
<ul id="listaAssinantes"></ul>
<button onclick="criarPendencia()">Criar pendência</button>

<hr>

<h2>Status da Pendência</h2>
<div id="status"></div>

<hr>

<h2>Assinatura</h2>
<p id="infoAssinatura"></p>
<canvas id="canvas" width="400" height="150"></canvas><br>
<button onclick="limpar()">Limpar</button>
<button onclick="assinar()">Assinar</button>

<div id="qrcode"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, getDoc,
  updateDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDryNN2dm0n2LCKizWDUoxVUStoiii0s7A",
  authDomain: "assinatura-3909b.firebaseapp.com",
  projectId: "assinatura-3909b",
  storageBucket: "assinatura-3909b.firebasestorage.app",
  messagingSenderId: "942453294900",
  appId: "1:942453294900:web:b4404f90f001c9778f0761"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let assinantes = [];
let pendenciaId = null;
let assinanteAtual = null;

// ---------- CRIAÇÃO ----------
window.adicionarAssinante = () => {
  const nome = nomeAssinante.value.trim();
  if (!nome) return;
  assinantes.push({ id: crypto.randomUUID(), nome, status: "PENDENTE" });
  nomeAssinante.value = "";
  renderLista();
};

function renderLista() {
  listaAssinantes.innerHTML = "";
  assinantes.forEach(a => {
    const li = document.createElement("li");
    li.textContent = a.nome;
    listaAssinantes.appendChild(li);
  });
}

window.criarPendencia = async () => {
  const ref = await addDoc(collection(db, "pendencias"), {
    criadaEm: new Date(),
    status: "PENDENTE",
    assinantes
  });
  pendenciaId = ref.id;
  observar();
};

// ---------- OBSERVAÇÃO ----------
function observar() {
  onSnapshot(doc(db, "pendencias", pendenciaId), snap => {
    const dados = snap.data();
    status.innerHTML = "";
    dados.assinantes.forEach(a => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <b>${a.nome}</b><br>
        Status: <span class="${a.status === "ASSINADO" ? "assinado" : "pendente"}">${a.status}</span><br>
        ${a.assinatura ? `
          Hash: ${a.assinatura.hash}<br>
          Data: ${new Date(a.assinatura.dataHora).toLocaleString()}<br>
          <img src="${a.assinatura.imagem}" width="200">
        ` : `
          <button onclick="prepararAssinatura('${a.id}')">Assinar</button>
        `}
      `;
      status.appendChild(div);
    });
  });
}

// ---------- ASSINATURA ----------
window.prepararAssinatura = (id) => {
  assinanteAtual = id;
  infoAssinatura.textContent = "Assinando como: " +
    assinantes.find(a => a.id === id).nome;

  const url = `${location.origin}${location.pathname}?pendenciaId=${pendenciaId}&assinanteId=${id}`;
  qrcode.innerHTML = "";
  new QRCode(qrcode, url);
};

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let desenhando = false;

canvas.onmousedown = () => desenhando = true;
canvas.onmouseup = () => { desenhando = false; ctx.beginPath(); };
canvas.onmousemove = e => {
  if (!desenhando) return;
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
};

window.limpar = () => ctx.clearRect(0,0,canvas.width,canvas.height);

async function gerarHash(base64) {
  const buffer = new TextEncoder().encode(base64);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, "0")).join("");
}

window.assinar = async () => {
  if (!assinanteAtual) return alert("Selecione um assinante");
  const imagem = canvas.toDataURL();
  const hash = await gerarHash(imagem);

  const ref = doc(db, "pendencias", pendenciaId);
  const snap = await getDoc(ref);
  const dados = snap.data();

  dados.assinantes = dados.assinantes.map(a =>
    a.id === assinanteAtual
      ? { ...a, status: "ASSINADO", assinatura: { imagem, hash, dataHora: new Date().toISOString() } }
      : a
  );

  await updateDoc(ref, { assinantes: dados.assinantes });
  limpar();
};

// ---------- SUPORTE QR ----------
const params = new URLSearchParams(location.search);
const pid = params.get("pendenciaId");
const aid = params.get("assinanteId");

if (pid && aid) {
  pendenciaId = pid;
  assinanteAtual = aid;
  observar();
}
</script>

</body>
</html>
