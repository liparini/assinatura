<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Assinatura Digital</title>
<style>
body { font-family: Arial; padding: 20px; }
input, button { padding: 8px; margin: 5px; }
canvas { border: 1px solid #ccc; margin-top: 10px; }
.assinado { color: green; font-weight: bold; }
.pendente { color: orange; font-weight: bold; }
.card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
#qrcode { margin-top: 20px; }
</style>
</head>
<body>

<h2>Adicionar Assinante à Pendência</h2>
<input id="nomeAssinante" placeholder="Nome do assinante">
<button id="btnAdicionarAssinante">Adicionar Assinante</button>

<p>Pendência ID: <span id="pendenciaId">Nenhuma</span></p>

<hr>

<h2>Assinaturas</h2>
<p id="infoAssinatura"></p>
<canvas id="canvas" width="400" height="150"></canvas><br>
<button onclick="limparCanvas()">Limpar</button>
<button id="btnAssinar">Assinar</button>

<div id="qrcode"></div>

<ul id="listaAssinantes"></ul>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  serverTimestamp,
  onSnapshot,
  query
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

// Configuração Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDryNN2dm0n2LCKizWDUoxVUStoiii0s7A",
  authDomain: "assinatura-3909b.firebaseapp.com",
  projectId: "assinatura-3909b",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Variáveis globais
let pendenciaId = null;
let assinanteAtual = null;

// ---------- CANVAS ----------
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let desenhando = false;

canvas.onmousedown = () => desenhando = true;
canvas.onmouseup = () => { desenhando = false; ctx.beginPath(); };
canvas.onmousemove = e => {
  if (!desenhando) return;
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
};
window.limparCanvas = () => ctx.clearRect(0,0,canvas.width,canvas.height);

// ---------- FUNÇÕES FIRESTORE ----------

// Adicionar assinante (cria pendência automaticamente)
document.getElementById("btnAdicionarAssinante").onclick = async () => {
  const nome = document.getElementById("nomeAssinante").value.trim();
  if (!nome) return alert("Informe o nome do assinante");

  try {
    // Se não existe pendência, criar pendência
    if (!pendenciaId) {
      const docRef = await addDoc(collection(db, "pendencias"), {
        status: "PENDENTE",
        criadoEm: serverTimestamp()
      });
      pendenciaId = docRef.id;
      document.getElementById("pendenciaId").textContent = pendenciaId;
      alert("Pendência criada automaticamente!");
      escutarPendencia();
    }

    // Adicionar assinante
    await addDoc(collection(db, "pendencias", pendenciaId, "assinantes"), {
      nome,
      status: "PENDENTE",
      criadoEm: serverTimestamp()
    });

    document.getElementById("nomeAssinante").value = "";
  } catch(err) {
    console.error(err);
    alert("Erro: " + err.message);
  }
};

// ---------- REALTIME FIRESTORE ----------
function escutarPendencia() {
  if (!pendenciaId) return;

  const assinantesRef = collection(db, "pendencias", pendenciaId, "assinantes");
  const q = query(assinantesRef);

  onSnapshot(q, snap => {
    const lista = document.getElementById("listaAssinantes");
    lista.innerHTML = "";
    let todosAssinaram = true;

    snap.forEach(docSnap => {
      const a = docSnap.data();
      const li = document.createElement("li");

      if (a.status === "ASSINADO") {
        li.innerHTML = `
          <b class="assinado">${a.nome}</b><br>
          Hash: ${a.hash}<br>
          Data/Hora: ${a.dataHora}<br>
          <img src="${a.imagem}" width="200">
        `;
      } else {
        li.innerHTML = `
          ${a.nome} <button onclick="prepararAssinatura('${docSnap.id}','${a.nome}')">Assinar</button>
        `;
        todosAssinaram = false;
      }

      lista.appendChild(li);
    });

    // Atualizar status da pendência
    updateDoc(doc(db, "pendencias", pendenciaId), { status: todosAssinaram ? "CONCLUIDO" : "PENDENTE" });
  });
}

// Preparar assinatura (selecionar assinante)
window.prepararAssinatura = (id, nome) => {
  assinanteAtual = id;
  document.getElementById("infoAssinatura").textContent = "Assinando como: " + nome;

  // QR Code único
  const url = `${location.origin}${location.pathname}?pendenciaId=${pendenciaId}&assinanteId=${id}`;
  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
};

// Gerar hash SHA-256
async function gerarHash(base64) {
  const buffer = new TextEncoder().encode(base64);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2,"0")).join("");
}

// Assinar
document.getElementById("btnAssinar").onclick = async () => {
  if (!assinanteAtual) return alert("Selecione um assinante");

  const imagem = canvas.toDataURL();
  const hash = await gerarHash(imagem);

  try {
    const ref = doc(db, "pendencias", pendenciaId, "assinantes", assinanteAtual);
    await updateDoc(ref, {
      status: "ASSINADO",
      hash,
      imagem,
      dataHora: new Date().toLocaleString()
    });

    limparCanvas();
    alert("Assinatura registrada com sucesso!");
  } catch(err) {
    console.error(err);
    alert("Erro ao assinar: " + err.message);
  }
};

// Ler parâmetros de QR
const params = new URLSearchParams(location.search);
const pid = params.get("pendenciaId");
const aid = params.get("assinanteId");
if (pid && aid) {
  pendenciaId = pid;
  assinanteAtual = aid;
  escutarPendencia();
}
</script>
</body>
</html>
